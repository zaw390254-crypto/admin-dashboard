<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order History</title>

<style>
body{font-family:system-ui;background:#f4f5fb;margin:0}
.header{
  background:#fff;
  padding:14px;
  font-weight:700;
  border-bottom:1px solid #ddd;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.balance{font-size:14px;color:#2e7d32}
.card{background:#fff;margin:12px;padding:14px;border-radius:12px;border:1px solid #ddd}
.status{font-weight:700}
.processing{color:#ff9800}
.progress{color:#2196f3}
.complete{color:#2e7d32}
.small{font-size:13px;color:#555}
button{
  margin:12px;
  padding:12px;
  width:calc(100% - 24px);
  border:none;
  border-radius:12px;
  background:#5f5b7a;
  color:#fff
}
</style>
</head>

<body>

<div class="header">
  ğŸ“¦ Order History
  <span class="balance" id="balanceBox"></span>
</div>

<div id="orderList"></div>
<button onclick="history.back()">â¬…ï¸ á€”á€±á€¬á€€á€ºá€á€­á€¯á€·</button>

<script>
// ===== USER & BALANCE =====
const username = localStorage.getItem("username");
const balance = localStorage.getItem("balance_" + username) || 0;
document.getElementById("balanceBox").innerText = "Balance : Ks " + balance;

let orders = JSON.parse(localStorage.getItem("orders") || "[]");

// â± status check
function getStatus(o){
  const now = Date.now();
  const diffMin = (now - o.createdAt) / 60000;

  if(diffMin < 10){
    return "processing";
  }
  if(diffMin < o.avgMinutes){
    return "progress";
  }
  return "complete";
}

// âŒ Cancel request
function cancelOrder(orderId){
  orders = orders.map(o=>{
    if(o.id === orderId){
      o.cancelRequested = true;
      o.cancelAt = Date.now() + 5 * 60 * 1000; // 5 min
    }
    return o;
  });

  localStorage.setItem("orders", JSON.stringify(orders));
  alert("Admin á€…á€®á€á€­á€¯á€·á€›á€±á€¬á€€á€ºá€›á€¾á€­á€á€½á€¬á€¸á€•á€«á€•á€¼á€®\n5 á€™á€­á€”á€…á€ºá€¡á€á€½á€„á€ºá€¸ á€–á€»á€€á€ºá€á€­á€™á€ºá€¸á€•á€±á€¸á€™á€Šá€º");
  render();
}

// ğŸ§¹ Auto remove cancelled orders
function cleanupCancelled(){
  const now = Date.now();
  orders = orders.filter(o=>{
    if(o.cancelRequested && now >= o.cancelAt){
      return false; // remove
    }
    return true;
  });
  localStorage.setItem("orders", JSON.stringify(orders));
}

// ğŸ“¦ Render orders
function render(){
  cleanupCancelled();

  const myOrders = orders.filter(o=>o.user===username);
  orderList.innerHTML = "";

  if(myOrders.length===0){
    orderList.innerHTML = `<div class="card">Order á€™á€›á€¾á€­á€á€±á€¸á€•á€«</div>`;
    return;
  }

  myOrders.reverse().forEach(o=>{
    const status = getStatus(o);

    let statusHTML = "";
    if(status==="processing"){
      statusHTML = `<span class="status processing">ğŸŸ¡ Processing</span>`;
    }else if(status==="progress"){
      statusHTML = `<span class="status progress">ğŸ”µ In Progress</span>`;
    }else{
      statusHTML = `<span class="status complete">ğŸŸ¢ Complete</span>`;
    }

    let cancelBtn = "";
    if(status==="processing" && !o.cancelRequested){
      cancelBtn = `
        <button onclick="cancelOrder(${o.id})"
        style="margin-top:10px;background:#e53935">
        âŒ Cancel Service
        </button>`;
    }

    if(o.cancelRequested){
      cancelBtn = `<div class="small">â³ Cancel request sent</div>`;
    }

    orderList.innerHTML += `
      <div class="card">
        <b>ğŸ†” Order ID :</b> ${o.id}<br>
        <b>ğŸ“¦ Service :</b> ${o.service}<br>
        <b>ğŸ”¢ Amount :</b> ${o.amount}<br>
        <b>ğŸ”— Link :</b> <span class="small">${o.link}</span><br><br>
        ${statusHTML}
        ${cancelBtn}
      </div>
    `;
  });
}

render();
setInterval(render, 30000); // auto refresh
</script>
